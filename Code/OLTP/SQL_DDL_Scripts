-- Create OLTP Schema

CREATE SCHEMA IF NOT EXISTS oltp;

-- Customer Table

CREATE TABLE oltp.Customer (
    customer_id VARCHAR(50) PRIMARY KEY,
    first_name  VARCHAR(100) NOT NULL,
    last_name   VARCHAR(100) NOT NULL,
    postcode    VARCHAR(20),
    d_o_b       DATE,
    created_at  TIMESTAMP DEFAULT NOW() NOT NULL,
    updated_at  TIMESTAMP
);


-- Customer Financial Profile Table

CREATE TABLE oltp.Customer_Financial_Profile (
    profile_id   VARCHAR(50) PRIMARY KEY,
    customer_id  VARCHAR(50) NOT NULL,
    credit_score NUMERIC(3) CHECK (credit_score BETWEEN 0 AND 999),
    source       VARCHAR(100),
    retrieved_at DATE,
    created_at   TIMESTAMP DEFAULT NOW() NOT NULL,
    updated_at   TIMESTAMP,
    CONSTRAINT fk_customer_fin FOREIGN KEY (customer_id) REFERENCES oltp.Customer(customer_id)
);


-- Policy Table

CREATE TABLE oltp.Policy (
    policy_id          VARCHAR(50) PRIMARY KEY,
    customer_id        VARCHAR(50) NOT NULL,
    annual_premium_amount NUMERIC(15,2),
    policy_type        VARCHAR(50) CHECK (policy_type IN ('MOTOR','HOME')),
    start_date         DATE,
    end_date           DATE,
    status             VARCHAR(20) CHECK (status IN ('pending','active','lapsed','terminated','settled','expired')),
    created_at         TIMESTAMP DEFAULT NOW() NOT NULL,
    updated_at         TIMESTAMP,
    CONSTRAINT fk_policy_customer FOREIGN KEY (customer_id) REFERENCES oltp.Customer(customer_id),
    CONSTRAINT chk_policy_dates CHECK (end_date IS NULL OR end_date >= start_date)
);


--  Claims Table

CREATE TABLE oltp.Claims (
    claim_id        VARCHAR(50) PRIMARY KEY,
    policy_id       VARCHAR(50) NOT NULL,
    incident_date_time TIMESTAMP,
    report_date     DATE,
    claim_amount    NUMERIC(15,2),
    incident_type   VARCHAR(100),
    incident_lat    NUMERIC(10,6),
    incident_long   NUMERIC(10,6),
    incident_location VARCHAR(200),
    status          VARCHAR(20) CHECK (status IN ('reported','under_review','approved','rejected','settled')),
    image_id        VARCHAR(50),
    created_at      TIMESTAMP DEFAULT NOW() NOT NULL,
    updated_at      TIMESTAMP,
    CONSTRAINT fk_claim_policy FOREIGN KEY (policy_id) REFERENCES oltp.Policy(policy_id)
);



-- Payments Table 

CREATE TABLE oltp.Payment (
    payment_id     VARCHAR(50) PRIMARY KEY,
    claim_id       VARCHAR(50) UNIQUE,
    policy_id      VARCHAR(50) NOT NULL,
    payment_date   DATE NOT NULL,
    amount         NUMERIC(15,2) NOT NULL,
    payment_method VARCHAR(50) CHECK (payment_method IN ('credit_card','bank_transfer','cash','cheque')),
    status         VARCHAR(20) CHECK (status IN ('pending','completed','failed','refunded')),
    created_at     TIMESTAMP DEFAULT NOW() NOT NULL,
    updated_at     TIMESTAMP,
    CONSTRAINT fk_payment_policy FOREIGN KEY (policy_id) REFERENCES oltp.Policy(policy_id),
    CONSTRAINT fk_payment_claim FOREIGN KEY (claim_id) REFERENCES oltp.Claims(claim_id)
);
